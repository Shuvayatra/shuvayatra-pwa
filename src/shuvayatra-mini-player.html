<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="shared-styles.html">
<dom-module id="shuvayatra-mini-player">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        --paper-slider-active-color: #fff;
        --paper-slider-knob-color: #fff;
        --paper-slider-knob-start-color: #fff;
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 0;
        color: #fff;
        max-width: 750px;
        margin: 0 auto;
        z-index: 99;
        width: 100%;
      }
      .playlist div:nth-of-type({{this.index}}){
        background: black;
      }
                  paper-icon-button {
                width: 80px;
                height: 60px;
            }

            paper-slider {
                width: 100%;
                --paper-slider-container-color: #fff;
                --paper-slider-knob-start-border-color: #fff;
            }

      .player-container {
        background-color: #7bd086;
      }
      .playlist-container{
        overflow: hidden;
        background-color: #7bd086;
        max-height:400px;
      }
      .playlist{
          display: block;
          max-height: 380px;
          width: 100%;
          height: auto;
          overflow-y: auto;
      }
      iron-image{
        width: 80px;
        height: 55px;
      }
      .details{
        display: block;
        padding-left: 10px;
        width: 100%;
        cursor: pointer;
      }
    </style>
    <audio id="audio" src="{{ track.mediaUrl }}"></audio>

    <div hidden$="[[_playerHidden]]">
      <div hidden$="[[!playListShown]]" class="playlist-container">
        <div class="playlist">
          <template is="dom-repeat" items="[[tracks]]">
            <div class="flex list-item">
              <a href="/channel/[[item.channel.id]]">
                <iron-image sizing="cover" placeholder="../images/image-default.png" preload fade src="{{ httpToHttps(item.channel.coverImageThumbnail) }}"></iron-image>
              </a>
              <div class="block pointer" on-click="_playItem">
                <label>{{ item.title }}</label>
                <div>[[ itemDesc(item)]]</div>
              </div>
              <div class="right">
                <paper-icon-button icon="cancel" on-click="_removeFromQueue"></paper-icon-button>
                <paper-tooltip>Remove from Queue</paper-tooltip>
              </div>
            </div>
          </template>
        </div>
        <paper-slider id="seekbar" value="{{ progress }}"></paper-slider>
      </div>
      <div class="player-container flex">
        <paper-icon-button on-tap="playPause" icon="av:{{_computePlayPause(paused)}}"></paper-icon-button>
        <a href="/channel/[[track.channel.id]]">
          <iron-image sizing="cover" placeholder="../images/image-default.png" preload fade src="[[httpToHttps(track.channel.coverImage)]]"></iron-image>
        </a>
        <div class="details" on-click="_fullPlayer">
          <label>{{ track.title}}</label>
          <div>{{ _computeProgress(currentTime, duration)}}</div>
        </div>
        <div class="right">
          <paper-icon-button on-tap="skipNext" icon="av:skip-next"></paper-icon-button>
          <paper-tooltip>Skip to Next</paper-tooltip>
        </div>
      </div>
    </div>
  </template>

  <script>

      class MiniPlayer extends Polymer.Element{
        constructor(){
          super()
        }
        static get is(){
          return 'shuvayatra-mini-player'
        }
        static get properties(){
          return {
              tracks : {
                type : Array,
                value : [],
              },
              track : {
                type : Object
              },
              paused : {
                type : Boolean,
                value: true
              },
              currentTime : {
                type : Number,
              },
              progress : {
                type : Number,
              },
              playListShown :{
                type : Boolean,
                value:false
              },
              _playerHidden : {
                type : Boolean,
                value : true
              }
          }
        }
        _computeProgress(c,d){
          return this._convertSecToMin(c) + " | " + this._convertSecToMin(d);
        }

        ready(){
           super.ready();
           this.$.audio.addEventListener("loadedmetadata", e => this.duration = e.target.duration)
           this.$.audio.addEventListener("timeupdate", e => {
             this.currentTime = e.target.currentTime
             this.progress = (e.target.currentTime / e.target.duration) * 100
           })
           this.$.audio.addEventListener('ended', e => this.skipNext())
           // This is required so that playing of audio does not update the seekbar back.
           // Without this, a flicker will be seen everysecond when we hold the seekbar.
           this.$.seekbar.addEventListener('immediate-value-change', e =>
                this.$.audio.pause())
           this.$.seekbar.addEventListener("change", e => {
             this.$.audio.currentTime = e.target.value * this.$.audio.duration / 100
             this.$.audio.play();
           })
        }
        playPause(){
          this.$.audio.paused ? this.play() : this.pause()
        }
        pause(){
          this.$.audio.pause()
          this.paused = true
        }
        play(){
          this.$.audio.play()
          this.paused = false
        }
        _convertSecToMin (seconds) {
            if (!seconds || seconds === 0) return '00:00';
            var minutes = Math.floor(seconds / 60);
            var secondsToCalc = Math.floor(seconds % 60) + '';
            return minutes + ':' + (secondsToCalc.length < 2 ? '0' + secondsToCalc : secondsToCalc);
        }
        _computePlayPause(paused){
          return this.paused ? 'play-arrow' : 'pause'
        }
        httpToHttps(u){
          return u.replace('http://', 'https://')
        }
        _playItem(e){
          this.$.audio.pause()
          this.track = this.tracks[e.model.__data.index]
          this.$.audio.play()
        }
        _removeFromQueue(e){
          let index = e.model.__data.index
          this.splice('tracks', index, 1)
          if(index === this.index){
            this.track = this.tracks[index]
            this.$.audio.play()
          }
        }
        _fullPlayer(){
          this.playListShown = !this.playListShown
        }
        playIndex(index){
          this.index = index >= this.tracks.length ? this.tracks.length - 1 : index
          if(this.tracks.length === 0){
            this.$.audio.pause()
            return;
          }
          this.track = this.tracks[this.index]
          this.$.audio.play();
          this.paused = false;
        }
        addTrack(track){
          this.unshift('tracks', track)
          this._playerHidden = false
        }
        queueTrack(track){
          this.push('tracks', track)
          this._playerHidden = false
        }
        skipNext(){
          this.splice('tracks', this.index, 1)
          this._playerHidden = this.tracks.length === 0
          this.playIndex(this.index)
        }
        itemDesc(item){
          return `${item.publishedDate} | ${ Math.round(item.duration / 6) / 10} MIN | ${ Math.round(item.filesize / 1048576) / 10} MB `
        }
      }
      customElements.define(MiniPlayer.is, MiniPlayer)
    </script>
</dom-module>
