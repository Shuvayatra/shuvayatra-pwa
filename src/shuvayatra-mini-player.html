<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="shared-styles.html">
<dom-module id="shuvayatra-mini-player">
    <template>
        <style include="shared-styles">
        :host {
            display: block;
            padding: 10px;
            --paper-slider-active-color: #fff;
            --paper-slider-knob-color: #fff;
            --paper-slider-knob-start-color: #fff;
        }
        
        paper-icon-button {
            width: 80px;
            height: 80px;
        }
        
        paper-icon-button[hidden] {
            display: none;
        }
        
        paper-slider {
            width: 100%;
        }
        
        .player-container {
            background-color: #ddd;
        }
        </style>
        <div class="player-container">
            <div>
                <div on-tap="_playPause">
                    <paper-icon-button icon="av:play-circle-outline" hidden$="{{ _hidePlayIcon(isPlaying, canBePlayed) }}"></paper-icon-button>
                    <paper-icon-button icon="av:pause-circle-outline" hidden$="{{ !isPlaying }}"></paper-icon-button>
                </div>
                <div>
                    <label>{{ _getTitle(playIndex) }}</label>
                    <audio id="audio" src="{{ _getSource(playIndex) }}"></audio>
                    <div id="duration">
                        <span class="fit">{{ _getProgress(currentTime) }}</span>
                    </div>
                </div>
            </div>
            <paper-slider id="seekbar" value="{{ seekbarValue }}"></paper-slider>
        </div>
    </template>
    <script>
    Polymer({
        is: 'shuvayatra-mini-player',

        listeners: {
            'audio.loadedmetadata': '_onCanPlay',
            'audio.playing': '_onPlaying',
            'audio.pause': '_onPause',
            'audio.ended': '_onEnd',
            'audio.error': '_onError',
            'immediate-value-change': '_onSeekbarPositionChanged',
            'change': '_onSeekbarPositionChanged'
        },

        observers: [
            '_onProgressChanged(percentagePlayed)'
        ],

        properties: {
            tracks: {
                type: Array,
                notify: true
            },

            playIndex: {
                type: Number
            }
        },

        ready: function(){
            this.isPlaying = false;
            this.canBePlayed = true;
        },

        _onCanPlay: function() {
            this.canBePlayed = true;

            if (this.timeOffset > 0) {
                this.percentagePlayed = this.timeOffset / this.$.audio.duration;
            }
        },

        _onPlaying: function() {
            this.ended = false;
            this.isPlaying = true;
            this._startProgressTimer();
        },

        _onPause: function() {
            this.isPlaying = false;
        },

        _onEnd: function() {
            this.ended = true;
            this.isPlaying = false;

            if (this.playIndex < this.tracks.length - 1) {
                this.playIndex += 1;
                this.seekbarValue = 0;
            }
        },

        _onError: function() {
            // this.title = 'Sorry, can\'t play track: ' + this.title;
            this.error = true;
        },

        _onSeekbarPositionChanged: function() {
            var value = this.$.seekbar.immediateValue;
            var player = this;
            if (player.canBePlayed) {
                player._updateAudioProgress(value);
                if (!player.isPlaying) player.$.audio.play();
            } else if (player.preload === 'none') {
                player.$.audio.load();
                player.$.audio.addEventListener('loadedmetadata', function() {
                    player._updateAudioProgress(value);
                    if (!player.isPlaying) player.$.audio.play();
                }, false);
            }
        },

        _updateAudioProgress: function(progress) {
            var audio = this.$.audio;
            var totalDuration = audio.duration;
            this.currentTime = audio.currentTime = (progress * totalDuration) / 100;
        },

        _startProgressTimer: function() {
            var player = this;
            player.timer = {};
            if (player.timer.sliderUpdateInterval) {
                clearInterval(player.timer.sliderUpdateInterval);
            }

            player.timer.sliderUpdateInterval = setInterval(function() {
                if (player.isPlaying) {
                    player.currentTime = player.$.audio.currentTime;
                    player.duration = player.$.audio.duration;
                    player.percentagePlayed = (player.currentTime / player.$.audio.duration) * 100;
                } else {
                    clearInterval(player.timer.sliderUpdateInterval);
                }
            }, 100);
        },

        _convertSecToMin: function(seconds) {
            if (!seconds || seconds === 0) return '00:00';
            var minutes = Math.floor(seconds / 60);
            var secondsToCalc = Math.floor(seconds % 60) + '';
            return minutes + ':' + (secondsToCalc.length < 2 ? '0' + secondsToCalc : secondsToCalc);
        },

        _hidePlayIcon: function(isPlaying, canBePlayed) {
            return isPlaying ? true : !(canBePlayed || this.preload === 'none');
        },

        _playPause: function(e) {
            e.preventDefault();
            if (this.canBePlayed) {
                return this.isPlaying ? this.$.audio.pause() : this.$.audio.play();
            } else if (this.preload === 'none') {
                this.$.audio.load();
                this.$.audio.play();
            }
        },

        _onProgressChanged: function(progress) {
            if (!this.$.seekbar.pressed) {
                this.seekbarValue = progress;
            }
        },

        _getProgress: function(currentTime) {
            return this._convertSecToMin(this.currentTime) + " | " + this._convertSecToMin(this.duration);
        },

        _getTitle: function(index) {
            if (this.tracks && index !== -1) {
                return this.tracks[index].title;
            } else {
                return "---";
            }
        },

        _getSource: function(index) {
            if (this.tracks && index !== -1) {
                return this.tracks[index].source;
            }
        },

        _stopPlayback: function(){
            this.playIndex = -1;
            this.$.audio.pause();
            this.currentTime = this.$.audio.currentTime = 0;
            this.$.seekbar.value = 0;
        },

        _startPlayback: function(){
            this.$.audio.play();
        }

    });
    </script>
</dom-module>
