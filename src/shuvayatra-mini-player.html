<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="shared-styles.html">
<dom-module id="shuvayatra-mini-player">
  <template>
    <style include="shared-styles">
            :host {
                display: block;
                --paper-slider-active-color: #fff;
                --paper-slider-knob-color: #fff;
                --paper-slider-knob-start-color: #fff;
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                padding: 0;
                color: #fff;
                max-width: 750px;
                margin: 0 auto;
                z-index: 99;
            }

            paper-icon-button {
                width: 80px;
                height: 80px;
            }

            paper-slider {
                width: 100%;
                --paper-slider-container-color: #fff;
                --paper-slider-knob-start-border-color: #fff;
            }

            .player-container {
                background-color: #7bd086;
            }
    </style>
    <audio id="audio" src="{{ track.source }}"></audio>
    <div class="player-container">
      <div class="player-container-inner">
        <paper-icon-button on-tap="playPause" icon="av:{{_computePlayPause(paused)}}-circle-outline"></paper-icon-button>
        <div>
          <label>{{ track.title}}</label>
          <div id="duration">
            <span class="fit">{{ _computeProgress(currentTime, duration)}}</span>
          </div>
        </div>
      </div>
      <paper-slider id="seekbar" value="{{ progress }}"></paper-slider>
    </div>
  </template>
    <script>
      class MiniPlayer extends Polymer.Element{
        constructor(){
          super()
        }
        static get is(){
          return 'shuvayatra-mini-player'
        }
        static get properties(){
          return {
              playIndex : {
                type : Number,
                observer : '_indexChanged'
              },
              tracks : {
                type : Array,
              },
              track : {
                type : Object
              },
              paused : {
                type : Boolean,
                value: true
              },
              currentTime : {
                type : Number,
              },
              progress : {
                type : Number,
              }
          }
        }
        _computeProgress(c,d){
          return this._convertSecToMin(c) + " | " + this._convertSecToMin(d);
        }

        ready(){
           super.ready();
           this.$.audio.addEventListener("loadedmetadata", e => this.duration = e.target.duration)
           this.$.audio.addEventListener("timeupdate", e => {
             this.currentTime = e.target.currentTime
             this.progress = (e.target.currentTime / e.target.duration) * 100
           })
           // This is required so that playing of audio does not update the seekbar back.
           // Without this, a flicker will be seen everysecond when we hold the seekbar.
           this.$.seekbar.addEventListener('immediate-value-change', e =>
                this.$.audio.pause())
           this.$.seekbar.addEventListener("change", e => {
             this.$.audio.currentTime = e.target.value * this.$.audio.duration / 100
             this.$.audio.play();
           })
        }
        _indexChanged(newIndex, old){
          if(newIndex > -1 && newIndex < this.tracks.length)
            this.track = this.tracks[newIndex]
          this.playIndex = newIndex
        }
        playPause(){
          this.$.audio.paused ? this.play() : this.pause()
        }
        pause(){
          this.$.audio.pause()
          this.paused = true
        }
        play(){
          this.$.audio.play()
          this.paused = false
        }
        _convertSecToMin (seconds) {
            if (!seconds || seconds === 0) return '00:00';
            var minutes = Math.floor(seconds / 60);
            var secondsToCalc = Math.floor(seconds % 60) + '';
            return minutes + ':' + (secondsToCalc.length < 2 ? '0' + secondsToCalc : secondsToCalc);
        }
        _computePlayPause(paused){
          return this.$.audio.paused ? 'play' : 'pause'
        }
      }
      customElements.define(MiniPlayer.is, MiniPlayer)
    </script>
</dom-module>
